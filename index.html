import React, { useState, useEffect } from 'react';
import { AlertCircle, Check, Clock, Lightbulb, RefreshCcw, ExternalLink } from 'lucide-react';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';

const EMPTY = 0;
const CHAIR = 1;
const ECO = 2;

const SUSTAINABILITY_FACTS = [
  "Did you know? KIAN's commitment to sustainability has led to a 30% reduction in our carbon footprint over the last 5 years.",
  "KIAN uses recycled materials in over 60% of our furniture products.",
  "Our sustainable practices have helped save over 1000 trees annually through our eco-friendly manufacturing processes."
];

const KianPuzzle = () => {
  const [grid, setGrid] = useState([
    [EMPTY, EMPTY, EMPTY, EMPTY],
    [EMPTY, EMPTY, EMPTY, EMPTY],
    [EMPTY, EMPTY, EMPTY, EMPTY],
    [EMPTY, EMPTY, EMPTY, EMPTY]
  ]);
  const [isComplete, setIsComplete] = useState(false);
  const [errors, setErrors] = useState([]);
  const [hintIndex, setHintIndex] = useState(-1);
  const [time, setTime] = useState(0);
  const [isActive, setIsActive] = useState(false);
  const [highlightedCells, setHighlightedCells] = useState([]);
  const [incompleteMessage, setIncompleteMessage] = useState(null);

  const horizontalConstraints = [
    [null, '=', null, null],
    [null, 'X', null, null],
    [null, null, '=', null],
    [null, null, null, null]
  ];

  const verticalConstraints = [
    [null, null, 'X', null],
    [null, '=', null, null],
    [null, null, null, null],
    [null, null, null, null]
  ];

  useEffect(() => {
    let interval = null;
    if (isActive && !isComplete) {
      interval = setInterval(() => {
        setTime(time => time + 1);
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [isActive, isComplete]);

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  const checkCompletion = (grid) => {
    const isFilled = grid.every(row => row.every(cell => cell !== EMPTY));
    if (!isFilled) return false;

    // Check row and column balance
    for (let i = 0; i < 4; i++) {
      const rowChairs = grid[i].filter(cell => cell === CHAIR).length;
      const rowEco = grid[i].filter(cell => cell === ECO).length;
      if (rowChairs !== rowEco) return false;

      const colChairs = grid.map(row => row[i]).filter(cell => cell === CHAIR).length;
      const colEco = grid.map(row => row[i]).filter(cell => cell === ECO).length;
      if (colChairs !== colEco) return false;
    }

    // Check for three in a row
    for (let i = 0; i < 4; i++) {
      for (let j = 0; j < 2; j++) {
        // Horizontal check
        if (grid[i][j] !== EMPTY && 
            grid[i][j] === grid[i][j+1] && 
            grid[i][j] === grid[i][j+2]) return false;
        
        // Vertical check
        if (grid[j][i] !== EMPTY && 
            grid[j][i] === grid[j+1][i] && 
            grid[j][i] === grid[j+2][i]) return false;
      }
    }

    // Check constraints
    for (let i = 0; i < 4; i++) {
      for (let j = 0; j < 3; j++) {
        if (horizontalConstraints[i][j]) {
          if (horizontalConstraints[i][j] === '=' && grid[i][j] !== grid[i][j+1]) return false;
          if (horizontalConstraints[i][j] === 'X' && grid[i][j] === grid[i][j+1]) return false;
        }
      }
    }

    return true;
  };

  const handleDoneClick = () => {
    const isValid = checkCompletion(grid);
    
    if (!grid.every(row => row.every(cell => cell !== EMPTY))) {
      showIncompleteMessage("Fill all cells before checking your solution!");
      return;
    }

    if (isValid) {
      setIsComplete(true);
      setIsActive(false);
    } else {
      const currentHint = generateHint();
      setHighlightedCells(currentHint.highlight);
      showIncompleteMessage("Nice try! But there are still some issues. Click 'Get Hint' for help.");
    }
  };

  const generateHint = () => {
    // Check for three in a row violations
    for (let i = 0; i < 4; i++) {
      for (let j = 0; j < 2; j++) {
        // Horizontal check
        if (grid[i][j] !== EMPTY && 
            grid[i][j] === grid[i][j+1] && 
            grid[i][j] === grid[i][j+2]) {
          return {
            tip: "Rule violation: No more than 2 identical symbols can be adjacent.",
            highlight: [[i, j], [i, j+1], [i, j+2]],
            solution: `These cells have three ${grid[i][j] === CHAIR ? 'ðŸª‘' : 'ðŸŒ¿'} in a row. Change one to ${grid[i][j] === CHAIR ? 'ðŸŒ¿' : 'ðŸª‘'}.`
          };
        }
      }
    }

    // Check constraint violations
    for (let i = 0; i < 4; i++) {
      for (let j = 0; j < 3; j++) {
        if (horizontalConstraints[i][j]) {
          const cell1 = grid[i][j];
          const cell2 = grid[i][j+1];
          if (cell1 !== EMPTY && cell2 !== EMPTY) {
            if (horizontalConstraints[i][j] === '=' && cell1 !== cell2) {
              return {
                tip: "Rule violation: Cells connected by = must contain the same symbol.",
                highlight: [[i, j], [i, j+1]],
                solution: "These cells must match. Change one to match the other."
              };
            }
            if (horizontalConstraints[i][j] === 'X' && cell1 === cell2) {
              return {
                tip: "Rule violation: Cells connected by Ã— must contain different symbols.",
                highlight: [[i, j], [i, j+1]],
                solution: "These cells must be different. Change one to the opposite symbol."
              };
            }
          }
        }
      }
    }

    // Check row balance
    for (let i = 0; i < 4; i++) {
      const rowChairs = grid[i].filter(cell => cell === CHAIR).length;
      const rowEco = grid[i].filter(cell => cell === ECO).length;
      if (rowChairs > 2 || rowEco > 2) {
        return {
          tip: `Row ${i + 1} must have an equal number of chairs and sustainability symbols.`,
          highlight: [[i, 0], [i, 1], [i, 2], [i, 3]],
          solution: `This row needs balance: currently has ${rowChairs} ðŸª‘ and ${rowEco} ðŸŒ¿`
        };
      }
    }

    return {
      tip: "Keep going! Remember to maintain balance in rows and columns.",
      highlight: [],
      solution: "Each row and column should have the same number of chairs and sustainability symbols."
    };
  };

  const showIncompleteMessage = (message) => {
    setIncompleteMessage(message);
    setTimeout(() => setIncompleteMessage(null), 3000);
  };

  const getNextHint = () => {
    const hint = generateHint();
    setHintIndex(prev => prev + 1);
    setHighlightedCells(hint.highlight);
  };

  const resetPuzzle = () => {
    setGrid([
      [EMPTY, EMPTY, EMPTY, EMPTY],
      [EMPTY, EMPTY, EMPTY, EMPTY],
      [EMPTY, EMPTY, EMPTY, EMPTY],
      [EMPTY, EMPTY, EMPTY, EMPTY]
    ]);
    setIsComplete(false);
    setErrors([]);
    setHintIndex(-1);
    setTime(0);
    setIsActive(false);
    setHighlightedCells([]);
    setIncompleteMessage(null);
  };

  const cycleCell = (row, col) => {
    if (!isActive) setIsActive(true);
    setGrid(prevGrid => {
      const newGrid = prevGrid.map(r => [...r]);
      newGrid[row][col] = (newGrid[row][col] + 1) % 3;
      return newGrid;
    });
  };

  const renderCell = (value, row, col) => {
    const hasError = errors.some(error => error.row === row && error.col === col);
    const isHighlighted = highlightedCells.some(([r, c]) => r === row && c === col);
    
    let content = "";
    switch(value) {
      case CHAIR:
        content = "ðŸª‘";
        break;
      case ECO:
        content = "ðŸŒ¿";
        break;
      default:
        content = "";
    }

    return (
      <div 
        className={`w-16 h-16 flex items-center justify-center text-3xl cursor-pointer 
          border border-indigo-200
          ${hasError ? "bg-red-50" : isHighlighted ? "bg-amber-50" : "bg-white"}
          ${value === EMPTY ? "hover:bg-indigo-50" : "hover:bg-indigo-100"}
          transition-colors duration-200`}
        onClick={() => cycleCell(row, col)}
      >
        {content}
      </div>
    );
  };

  return (
    <div className="p-8 max-w-6xl mx-auto bg-gradient-to-b from-indigo-50 to-white">
      <div className="flex items-center justify-between mb-8">
        <h1 className="text-4xl font-bold text-indigo-900">Furniture & Nature: A KIAN Logic Game</h1>
        <img src="/api/placeholder/50/50" alt="KIAN Falcon Logo" className="h-12 w-12" />
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
        <div>
          <Alert className="mb-6 border-indigo-200 bg-white shadow-lg">
            <AlertTitle className="text-indigo-900 text-xl font-bold mb-4">How to Play</AlertTitle>
            <AlertDescription className="text-indigo-800">
              <ul className="list-disc pl-4 space-y-3">
                <li>Fill the grid with either chairs (ðŸª‘) or sustainability symbols (ðŸŒ¿)</li>
                <li>No more than 2 of the same symbol can be adjacent horizontally or vertically</li>
                <li>Each row and column must have an equal number of each symbol</li>
                <li>Cells connected by = must have the same symbol</li>
                <li>Cells connected by Ã— must have different symbols</li>
                <li>Click on empty cells to cycle through symbols</li>
                <li>Once you've filled all cells, click 'Done' to check your solution</li>
                <li>If stuck, click 'Get Hint' for guidance</li>
              </ul>
            </AlertDescription>
          </Alert>

          <div className="flex gap-4 mb-6">
            <button
              onClick={getNextHint}
              className="flex items-center gap-2 px-4 py-2 bg-amber-500 text-white rounded hover:bg-amber-600 transition-colors shadow-md"
            >
              <Lightbulb className="h-4 w-4" />
              Get Hint
            </button>
            
            <button
              onClick={resetPuzzle}
              className="flex items-center gap-2 px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600 transition-colors shadow-md"
            >
              <RefreshCcw className="h-4 w-4" />
              Reset
            </button>

            <button
              onClick={handleDoneClick}
              className="flex items-center gap-2 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors shadow-md"
            >
              <Check className="h-4 w-4" />
              Done
            </button>

            <div className="flex items-center gap-2 px-4 py-2 bg-white rounded shadow-md">
              <Clock className="h-4 w-4 text-indigo-500" />
              {formatTime(time)}
            </div>
          </div>

          {hintIndex >= 0 && (
            <Alert className="mb-6 border-amber-200 bg-amber-50 shadow-md">
              <Lightbulb className="h-4 w-4 text-amber-800" />
              <AlertTitle className="text-amber-800 font-bold">Hint</AlertTitle>
              <AlertDescription className="space-y-2">
                <p className="text-amber-700">{generateHint().tip}</p>
                <p className="text-amber-900 font-semibold">{generateHint().solution}</p>
              </AlertDescription>
            </Alert>
          )}

          {incompleteMessage && (
            <Alert className="mb-6 border-amber-200 bg-amber-50 shadow-md">
              <AlertCircle className="h-4 w-4 text-amber-800" />
              <AlertDescription className="text-amber-800">
                {incompleteMessage}
              </AlertDescription>
            </Alert>
          )}

          {isComplete && (
            <Alert className="mb-6 border-green-200 bg-green-50 shadow-md">
              <Check className="h-4 w-4 text-green-800" />
              <AlertTitle className="text-green-800 text-xl font-bold">Congratulations!</AlertTitle>
              <AlertDescription className="space-y-4">
                <p className="text-green-700">
                  You've completed the puzzle in {formatTime(time)}!
                </p>
                <div className="bg-white p-4 rounded-lg">
                  <h3 className="font-semibold text-green-800 mb-2">Did You Know?</h3>
                  <p className="text-green-700">
                    {SUSTAINABILITY_FACTS[Math.floor(Math.random() *
